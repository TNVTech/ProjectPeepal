<%- contentFor('body') %>
    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">List of Rejected Requests</h3>
                        </div>
                        <div class="card-body">
                            <% if (rejectedRequests && rejectedRequests.length > 0) { %>
                                <table id="rejectedRequestsTable" class="table table-bordered table-striped">
                                    <thead>
                                        <tr>
                                            <th>Request ID</th>
                                            <th>Display Name</th>
                                            <th>Email</th>
                                            <th>Company</th>
                                            <th>Branch</th>
                                            <th>Role</th>
                                            <th>Request Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% rejectedRequests.forEach(function(request) { %>
                                        <tr data-request-id="<%= request.request_id %>"
                                            data-display-name="<%= request.display_name %>"
                                            data-email="<%= request.email %>"
                                            data-company="<%= request.company_name %>"
                                            data-branch="<%= request.branch_name %>"
                                            data-branch-id="<%= request.branch_id %>"
                                            data-role="<%= request.role_name %>"
                                            data-role-id="<%= request.role %>"
                                            data-request-date="<%= new Date(request.created_at).toLocaleString() %>"
                                            style="cursor: pointer;">
                                            <td><%= request.request_id %></td>
                                            <td><%= request.display_name %></td>
                                            <td><%= request.email %></td>
                                            <td><%= request.company_name %></td>
                                            <td><%= request.branch_name %></td>
                                            <td><%= request.role_name %></td>
                                            <td><%= new Date(request.created_at).toLocaleString() %></td>
                                        </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            <% } else { %>
                                <div class="alert alert-info">
                                    <h5><i class="icon fas fa-info"></i> No rejected requests</h5>
                                    There are no rejected requests at this time.
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Request Details Modal -->
<div class="modal fade" id="requestDetailsModal" tabindex="-1" role="dialog" aria-labelledby="requestDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="requestDetailsModalLabel">Request Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="requestDetailsForm">
                    <input type="hidden" id="requestId" name="requestId">
                    <div class="form-group">
                        <label for="displayName">Display Name</label>
                        <input type="text" class="form-control" id="displayName" readonly>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" class="form-control" id="email" readonly>
                    </div>
                    <div class="form-group">
                        <label for="company">Company</label>
                        <input type="text" class="form-control" id="company" readonly>
                    </div>
                    <div class="form-group">
                        <label for="branch">Branch</label>
                        <% if (activeUser.role === 'System Administrator' || (typeof userPrivileges !== 'undefined' && userPrivileges.includes('assign_branch'))) { %>
                            <div class="select2-purple">
                                <select class="form-control select2bs4" id="branch" name="branch" data-dropdown-css-class="select2-purple" style="width: 100%;">
                                    <option value="">Loading branches...</option>
                                </select>
                            </div>
                        <% } else { %>
                            <input type="text" class="form-control" id="branch" readonly>
                        <% } %>
                    </div>
                    <div class="form-group">
                        <label for="role">Role</label>
                        <% if (activeUser.role === 'System Administrator' || (typeof userPrivileges !== 'undefined' && userPrivileges.includes('assign_role'))) { %>
                            <div class="select2-purple">
                                <select class="form-control select2bs4" id="role" name="role" data-dropdown-css-class="select2-purple" style="width: 100%;">
                                    <option value="">Loading roles...</option>
                                </select>
                            </div>
                        <% } else { %>
                            <input type="text" class="form-control" id="role" readonly>
                        <% } %>
                    </div>
                    <div class="form-group">
                        <label for="requestDate">Request Date</label>
                        <input type="text" class="form-control" id="requestDate" readonly>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="showConfirmationModal('reapprove')">Reapprove</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel">Confirm Reapproval</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="confirmationForm" method="POST">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <input type="hidden" name="requestId" id="confirmRequestId">
                    <p id="confirmationMessage">Are you sure you want to reapprove this request? This will create a new user account.</p>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmActionBtn" onclick="submitConfirmationForm()">Confirm Reapproval</button>
            </div>
        </div>
    </div>
</div>

<%- contentFor('scripts') %>
<script>
    // Global variables
    let currentRequestId = '';
    let originalBranchId = '';
    let originalRoleId = '';
    
    // Function to load branches
    function loadBranches() {
        console.log("Loading branches");
        $.ajax({
            url: '/api/permission/branches',
            type: 'GET',
            success: function(response) {
                console.log("Branches loaded:", response);
                if (response.status === 'success') {
                    const branchSelect = $('#branch');
                    branchSelect.empty();
                    response.data.forEach(function(branch) {
                        const option = new Option(branch.b_name, branch.branch_id, false, branch.branch_id == originalBranchId);
                        branchSelect.append(option);
                    });
                    branchSelect.trigger('change');
                }
            },
            error: function(xhr, status, error) {
                console.error("Error loading branches:", error);
                const branchSelect = $('#branch');
                branchSelect.empty();
            }
        });
    }
    
    // Function to load roles
    function loadRoles() {
        console.log("Loading roles");
        $.ajax({
            url: '/api/permission/roles',
            type: 'GET',
            success: function(response) {
                console.log("Roles loaded:", response);
                if (response.status === 'success') {
                    const roleSelect = $('#role');
                    roleSelect.empty();
                    response.data.forEach(function(role) {
                        const option = new Option(role.role_name, role.role_id, false, role.role_id == originalRoleId);
                        roleSelect.append(option);
                    });
                    roleSelect.trigger('change');
                }
            },
            error: function(xhr, status, error) {
                console.error("Error loading roles:", error);
                const roleSelect = $('#role');
                roleSelect.empty();
            }
        });
    }
    
    // Function to show the confirmation modal
    function showConfirmationModal(action) {
        console.log("showConfirmationModal called with action:", action);
        currentRequestId = $('#requestId').val();
        
        // Get the selected branch and role IDs if they are dropdowns
        const branchElement = $('#branch');
        const roleElement = $('#role');
        const selectedBranchId = branchElement.is('select') ? branchElement.val() : originalBranchId;
        const selectedRoleId = roleElement.is('select') ? roleElement.val() : originalRoleId;
        
        // Set form values
        $('#confirmRequestId').val(currentRequestId);
        
        // Add branch and role to form data if they were changed
        if (selectedBranchId !== originalBranchId) {
            $('<input>').attr({
                type: 'hidden',
                name: 'branch_id',
                value: selectedBranchId
            }).appendTo('#confirmationForm');
        }
        
        if (selectedRoleId !== originalRoleId) {
            $('<input>').attr({
                type: 'hidden',
                name: 'role',
                value: selectedRoleId
            }).appendTo('#confirmationForm');
        }
        
        // Set the confirmation message
        $('#confirmationMessage').text('Are you sure you want to reapprove this request? This will create a new user account.');
        
        // Set the button color
        $('#confirmActionBtn').removeClass('btn-danger').addClass('btn-success');
        
        // Show the confirmation modal
        $('#confirmationModal').modal('show');
    }
    
    // Function to submit the confirmation form
    function submitConfirmationForm() {
        console.log("Submitting confirmation form");
        console.log("Request ID:", currentRequestId);
        
        // Show loading overlay if SweetAlert2 is available
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                title: 'Processing...',
                text: 'Please wait while we process your request.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
        } else {
            console.log("SweetAlert2 not available, showing basic alert");
            alert("Processing your request...");
        }
        
        // Get form data
        const formData = {
            requestId: currentRequestId,
            _csrf: $('input[name="_csrf"]').val()
        };
        
        console.log("Form data:", formData);
        
        // Submit via AJAX
        $.ajax({
            url: `/rejected-requests/${currentRequestId}/reapprove`,
            type: 'POST',
            data: formData,
            success: function(response) {
                console.log("Success response:", response);
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'The request has been reapproved successfully.',
                        showConfirmButton: false,
                        timer: 1500
                    }).then(() => {
                        window.location.reload();
                    });
                } else {
                    alert("Request reapproved successfully!");
                    window.location.reload();
                }
            },
            error: function(xhr, status, error) {
                console.error("Error:", error);
                console.error("Status:", status);
                console.error("Response:", xhr.responseText);
                
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: 'There was a problem processing your request. Please try again.'
                    });
                } else {
                    alert("Error: There was a problem processing your request. Please try again.");
                }
            }
        });
    }

    $(document).ready(function() {
        console.log("Document ready, initializing rejected requests page");
        
        // Initialize Select2 for dropdowns with AdminLTE styling
        if ($.fn.select2) {
            $('.select2bs4').select2({
                theme: 'bootstrap4',
                width: '100%',
                dropdownParent: $('#requestDetailsModal'),
                placeholder: 'Select an option',
                allowClear: true,
                containerCssClass: 'select2-purple',
                dropdownCssClass: 'select2-purple',
                language: {
                    noResults: function() {
                        return "No matches found";
                    }
                },
                templateResult: formatOption,
                templateSelection: formatOption
            });
        }
        
        // Initialize DataTable if available
        if (typeof $.fn.DataTable !== 'undefined') {
            $('#rejectedRequestsTable').DataTable({
                "paging": true,
                "lengthChange": true,
                "searching": true,
                "ordering": true,
                "info": true,
                "autoWidth": false,
                "responsive": true,
            });
            console.log("DataTable initialized");
        } else {
            console.error("DataTables is not loaded!");
            $('#rejectedRequestsTable').addClass('table-bordered table-striped');
        }

        // Handle row click to show request details
        $('#rejectedRequestsTable tbody').on('click', 'tr', function() {
            console.log("Row clicked");
            
            // Get data from the clicked row
            currentRequestId = $(this).data('request-id');
            const displayName = $(this).data('display-name');
            const email = $(this).data('email');
            const company = $(this).data('company');
            const branch = $(this).data('branch');
            const role = $(this).data('role');
            const requestDate = $(this).data('request-date');
            
            console.log("Request ID:", currentRequestId);
            console.log("Display Name:", displayName);
            
            // Store original branch and role IDs
            originalBranchId = $(this).data('branch-id');
            originalRoleId = $(this).data('role-id');
            console.log("Original Branch ID:", originalBranchId);
            console.log("Original Role ID:", originalRoleId);
            
            // Set the data in the modal
            $('#requestId').val(currentRequestId);
            $('#displayName').val(displayName);
            $('#email').val(email);
            $('#company').val(company);
            
            // Handle branch field
            const branchElement = $('#branch');
            if (branchElement.is('select')) {
                loadBranches();
            } else {
                branchElement.val(branch);
            }
            
            // Handle role field
            const roleElement = $('#role');
            if (roleElement.is('select')) {
                loadRoles();
            } else {
                roleElement.val(role);
            }
            
            $('#requestDate').val(requestDate);
            
            // Show the modal
            $('#requestDetailsModal').modal('show');
        });
    });

    // Function to format dropdown options
    function formatOption(option) {
        if (!option.id) {
            return option.text;
        }
        
        return $('<span>')
            .addClass('d-flex align-items-center')
            .text(option.text);
    }
</script>

<style>
    /* Custom Select2 Styling */
    .select2-container--bootstrap4 .select2-selection {
        border-radius: 0.25rem;
        border: 1px solid #ced4da;
        min-height: 38px;
        padding: 0.375rem 0.75rem;
    }

    .select2-container--bootstrap4 .select2-selection--single {
        display: flex;
        align-items: center;
    }

    .select2-container--bootstrap4 .select2-selection--single .select2-selection__rendered {
        color: #495057;
        line-height: 1.5;
        padding-left: 0;
    }

    .select2-container--bootstrap4 .select2-selection--single .select2-selection__arrow {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
    }

    .select2-container--bootstrap4 .select2-dropdown {
        border-color: #ced4da;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .select2-container--bootstrap4 .select2-results__option {
        padding: 8px 12px;
        font-size: 0.9rem;
    }

    .select2-container--bootstrap4 .select2-results__option--highlighted[aria-selected] {
        background-color: #6f42c1;
        color: white;
    }

    .select2-container--bootstrap4 .select2-results__option[aria-selected=true] {
        background-color: #e9ecef;
        color: #495057;
    }

    .select2-container--bootstrap4.select2-container--focus .select2-selection {
        border-color: #6f42c1;
        box-shadow: 0 0 0 0.2rem rgba(111, 66, 193, 0.25);
    }

    .select2-container--bootstrap4 .select2-selection--single .select2-selection__placeholder {
        color: #6c757d;
    }

    .select2-container--bootstrap4 .select2-search__field {
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
    }

    .select2-container--bootstrap4 .select2-search__field:focus {
        border-color: #6f42c1;
        box-shadow: 0 0 0 0.2rem rgba(111, 66, 193, 0.25);
    }
</style> 