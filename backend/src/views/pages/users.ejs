<%- contentFor('body') %>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">List of Active Users</h3>
                        </div>
                        <div class="card-body">
                            <% if (users && users.length > 0) { %>
                                <table id="usersTable" class="table table-bordered table-striped">
                                    <thead>
                                        <tr>
                                            <th>User ID</th>
                                            <th>Display Name</th>
                                            <th>Email</th>
                                            <th>Company</th>
                                            <th>Branch</th>
                                            <th>Role</th>
                                            <th>Created Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% users.forEach(function(user) { %>
                                        <tr data-user-id="<%= user.user_id %>"
                                            data-display-name="<%= user.display_name %>"
                                            data-email="<%= user.email %>"
                                            data-company="<%= user.c_name %>"
                                            data-branch="<%= user.b_name %>"
                                            data-role="<%= user.role_name %>"
                                            data-created-date="<%= new Date(user.created_at).toLocaleString() %>"
                                            style="cursor: pointer;">
                                            <td><%= user.user_id %></td>
                                            <td><%= user.display_name %></td>
                                            <td><%= user.email %></td>
                                            <td><%= user.c_name %></td>
                                            <td><%= user.b_name %></td>
                                            <td><%= user.role_name %></td>
                                            <td><%= new Date(user.created_at).toLocaleString() %></td>
                                        </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            <% } else { %>
                                <div class="alert alert-info">
                                    <h5><i class="icon fas fa-info"></i> No active users</h5>
                                    There are no active users at this time.
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- User Details Modal -->
<div class="modal fade" id="userDetailsModal" tabindex="-1" role="dialog" aria-labelledby="userDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userDetailsModalLabel">User Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="userDetailsForm">
                    <input type="hidden" id="userId" name="userId">
                    <div class="form-group">
                        <label for="displayName">Display Name</label>
                        <input type="text" class="form-control" id="displayName" readonly>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" class="form-control" id="email" readonly>
                    </div>
                    <div class="form-group">
                        <label for="company">Company</label>
                        <input type="text" class="form-control" id="company" readonly>
                    </div>
                    <div class="form-group">
                        <label for="branch">Branch</label>
                        <input type="text" class="form-control" id="branch" readonly>
                    </div>
                    <div class="form-group">
                        <label for="role">Role</label>
                        <input type="text" class="form-control" id="role" readonly>
                    </div>
                    <div class="form-group">
                        <label for="createdDate">Created Date</label>
                        <input type="text" class="form-control" id="createdDate" readonly>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" onclick="showConfirmationModal('revoke')">Revoke User</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel">Confirm Revocation</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="confirmationForm" method="POST">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <input type="hidden" name="userId" id="confirmUserId">
                    <p id="confirmationMessage">Are you sure you want to revoke this user? This action cannot be undone.</p>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmActionBtn" onclick="submitConfirmationForm()">Confirm Revocation</button>
            </div>
        </div>
    </div>
</div>

<%- contentFor('scripts') %>
<script>
    // Global variables
    let currentUserId = '';
    
    // Function to show the confirmation modal
    function showConfirmationModal(action) {
        console.log("showConfirmationModal called with action:", action);
        currentUserId = $('#userId').val();
        
        // Set form values
        $('#confirmUserId').val(currentUserId);
        
        // Set the confirmation message
        $('#confirmationMessage').text('Are you sure you want to revoke this user? This action cannot be undone.');
        
        // Set the button color
        $('#confirmActionBtn').removeClass('btn-success').addClass('btn-danger');
        
        // Show the confirmation modal
        $('#confirmationModal').modal('show');
    }
    
    // Function to submit the confirmation form
    function submitConfirmationForm() {
        console.log("Submitting confirmation form");
        console.log("User ID:", currentUserId);
        
        // Show loading overlay if SweetAlert2 is available
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                title: 'Processing...',
                text: 'Please wait while we process your request.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
        } else {
            console.log("SweetAlert2 not available, showing basic alert");
            alert("Processing your request...");
        }
        
        // Get form data
        const formData = {
            userId: currentUserId,
            _csrf: $('input[name="_csrf"]').val()
        };
        
        console.log("Form data:", formData);
        
        // Submit via AJAX
        $.ajax({
            url: `/users/${currentUserId}/revoke`,
            type: 'POST',
            data: formData,
            success: function(response) {
                console.log("Success response:", response);
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'The user has been revoked successfully.',
                        showConfirmButton: false,
                        timer: 1500
                    }).then(() => {
                        window.location.reload();
                    });
                } else {
                    alert("User revoked successfully!");
                    window.location.reload();
                }
            },
            error: function(xhr, status, error) {
                console.error("Error:", error);
                console.error("Status:", status);
                console.error("Response:", xhr.responseText);
                
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: 'There was a problem processing your request. Please try again.'
                    });
                } else {
                    alert("Error: There was a problem processing your request. Please try again.");
                }
            }
        });
    }

    $(document).ready(function() {
        console.log("Document ready, initializing users page");
        
        // Initialize DataTable if available
        if (typeof $.fn.DataTable !== 'undefined') {
            $('#usersTable').DataTable({
                "paging": true,
                "lengthChange": true,
                "searching": true,
                "ordering": true,
                "info": true,
                "autoWidth": false,
                "responsive": true,
            });
            console.log("DataTable initialized");
        } else {
            console.error("DataTables is not loaded!");
            $('#usersTable').addClass('table-bordered table-striped');
        }

        // Handle row click to show user details
        $('#usersTable tbody').on('click', 'tr', function() {
            console.log("Row clicked");
            
            // Get data from the clicked row
            currentUserId = $(this).data('user-id');
            const displayName = $(this).data('display-name');
            const email = $(this).data('email');
            const company = $(this).data('company');
            const branch = $(this).data('branch');
            const role = $(this).data('role');
            const createdDate = $(this).data('created-date');
            
            console.log("User ID:", currentUserId);
            console.log("Display Name:", displayName);
            
            // Set the data in the modal
            $('#userId').val(currentUserId);
            $('#displayName').val(displayName);
            $('#email').val(email);
            $('#company').val(company);
            $('#branch').val(branch);
            $('#role').val(role);
            $('#createdDate').val(createdDate);
            
            // Show the modal
            $('#userDetailsModal').modal('show');
        });
    });
</script> 